{"version":3,"file":"metadata.js","sources":["../src/index.ts"],"sourcesContent":["declare global {\n  interface DocumentEventMap {\n    'app-metadata': CustomEvent<Metadata>\n  }\n}\n\nexport function addMetadataListener() {\n  document.addEventListener('app-metadata', OnAppMetadata)\n}\n\nfunction OnAppMetadata(e: CustomEvent<Metadata>) {\n  updateMetadata(e.detail)\n}\n\nexport type Metadata = { [key: string]: string }\n\nexport type MetadataEntry = { key: string, value: string }\n\nexport function updateMetadata(data: Metadata, entries?: MetadataEntry[][] ) {\n  syncMedatadata({ ...data, url: data.url || document.location.href }, entries)\n}\n\nconst head = document.head\n\nfunction syncMedatadata(data: Metadata, entries?: MetadataEntry[][]) {\n  const keys = Object.keys(data)\n\n  for (let i = 0; i < keys.length; i++) {\n    const key = keys[i]\n    const value = data[key]\n\n    switch (key) {\n      case 'title':\n        document.title = value\n        break;\n      default:\n        setMetaValue(0, key, value)\n        break\n    }\n\n    switch (key) {\n      case 'title':\n      case 'description':\n      case 'image':\n      case 'url':\n        setMetaValue(0, 'og:' + key, value)\n        setMetaValue(0, 'twitter:' + key, value)\n        break\n    }\n  }\n\n  if (entries) {\n    for (let i = 0; i < entries.length; i++) {\n      const set = entries[i]\n      for (let j = 0; j < set.length; j++) {\n        const entry = set[j]\n        setMetaValue(i, entry.key, entry.value)\n      }\n    }\n  }\n\n  cleanupUnused()\n}\n\n// keep track of added meta elements so that\n// they can be reused or removed as required\ntype metaMap = { [key: string]: HTMLMetaElement[] }\nconst metaElements: metaMap = {}\n\nfunction setMetaValue(index: number, key: string, value: string) {\n  const attrName = key.startsWith('og:') ? 'property' : 'name'\n\n  let element: HTMLMetaElement | undefined\n  let elements = metaElements[key]\n  if (elements) {\n    element = elements[index]\n  } else {\n    elements = []\n    metaElements[key] = elements\n  }\n\n  if (element) {\n    element.content = value\n  } else {\n    const selector = `meta[${attrName}=\"${key}\"]`\n\n    let element = index\n      ? <HTMLMetaElement>head.querySelectorAll(selector)[index]\n      : <HTMLMetaElement>head.querySelector(selector)\n\n    if (!element) {\n      // otherwise create a new element\n      element = document.createElement('meta')\n      element.setAttribute(attrName, key)\n      head.appendChild(element)\n    }\n\n    element.content = value\n    elements[index] = element\n  }\n\n  updated[key] = index + 1\n}\n\n// count of updated metadata used in each iteration\nlet updated : { [key: string]: number } = {}\n\n// cleanup previously existing metatags that are now unused\nfunction cleanupUnused() {\n  const keys = Object.keys(metaElements)\n  for (let i = 0; i < keys.length; i++) {\n    const key = keys[i]\n    const elements = metaElements[key]\n    const used = updated[key] || 0\n    if (elements.length > used) {\n      for (let n = used; n < elements.length; n++) {\n        head.removeChild(elements[n])\n      }\n      elements.splice(used)\n    }\n  }\n\n  // reset for next time\n  updated = {}\n}\n"],"names":["document","addEventListener","OnAppMetadata","e","updateMetadata","detail","data","entries","syncMedatadata","url","location","href","head","keys","Object","i","length","key","value","title","setMetaValue","set","j","entry","cleanupUnused","metaElements","index","attrName","startsWith","element","elements","content","selector","querySelectorAll","querySelector","createElement","setAttribute","appendChild","updated","used","n","removeChild","splice"],"mappings":"4CAOEA,SAASC,iBAAiB,eAAgBC,eAG5C,uBAAuBC,GACrBC,eAAeD,EAAEE,QAOnB,wBAA+BC,EAAgBC,GAC7CC,gCAAoBF,GAAMG,IAAKH,EAAKG,KAAOT,SAASU,SAASC,OAAQJ,0DAGvE,MAAMK,KAAOZ,SAASY,KAEtB,wBAAwBN,EAAgBC,GACtC,MAAMM,EAAOC,OAAOD,KAAKP,GAEzB,IAAK,IAAIS,EAAI,EAAGA,EAAIF,EAAKG,OAAQD,IAAK,CACpC,MAAME,EAAMJ,EAAKE,GACXG,EAAQZ,EAAKW,GAEnB,OAAQA,GACN,IAAK,QACHjB,SAASmB,MAAQD,EACjB,MACF,QACEE,aAAa,EAAGH,EAAKC,GAIzB,OAAQD,GACN,IAAK,QACL,IAAK,cACL,IAAK,QACL,IAAK,MACHG,aAAa,EAAG,MAAQH,EAAKC,GAC7BE,aAAa,EAAG,WAAaH,EAAKC,IAKxC,GAAIX,EACF,IAAK,IAAIQ,EAAI,EAAGA,EAAIR,EAAQS,OAAQD,IAAK,CACvC,MAAMM,EAAMd,EAAQQ,GACpB,IAAK,IAAIO,EAAI,EAAGA,EAAID,EAAIL,OAAQM,IAAK,CACnC,MAAMC,EAAQF,EAAIC,GAClBF,aAAaL,EAAGQ,EAAMN,IAAKM,EAAML,QAKvCM,gBAMF,MAAMC,gBAEN,sBAAsBC,EAAeT,EAAaC,GAChD,MAAMS,EAAWV,EAAIW,WAAW,OAAS,WAAa,OAEtD,IAAIC,EACAC,EAAWL,aAAaR,GAQ5B,GAPIa,EACFD,EAAUC,EAASJ,IAEnBI,KACAL,aAAaR,GAAOa,GAGlBD,EACFA,EAAQE,QAAUb,MACb,CACL,MAAMc,UAAmBL,MAAaV,MAEtC,IAAIY,EAAUH,EACOd,KAAKqB,iBAAiBD,GAAUN,GAChCd,KAAKsB,cAAcF,GAEnCH,KAEHA,EAAU7B,SAASmC,cAAc,SACzBC,aAAaT,EAAUV,GAC/BL,KAAKyB,YAAYR,IAGnBA,EAAQE,QAAUb,EAClBY,EAASJ,GAASG,EAGpBS,QAAQrB,GAAOS,EAAQ,EAIzB,IAAIY,WAGJ,yBACE,MAAMzB,EAAOC,OAAOD,KAAKY,cACzB,IAAK,IAAIV,EAAI,EAAGA,EAAIF,EAAKG,OAAQD,IAAK,CACpC,MAAME,EAAMJ,EAAKE,GACXe,EAAWL,aAAaR,GACxBsB,EAAOD,QAAQrB,IAAQ,EAC7B,GAAIa,EAASd,OAASuB,EAAM,CAC1B,IAAK,IAAIC,EAAID,EAAMC,EAAIV,EAASd,OAAQwB,IACtC5B,KAAK6B,YAAYX,EAASU,IAE5BV,EAASY,OAAOH,IAKpBD"}