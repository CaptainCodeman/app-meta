{"version":3,"file":"metadata.min.js","sources":["../src/index.ts"],"sourcesContent":["declare global {\n  interface DocumentEventMap {\n    'app-metadata': CustomEvent<Metadata>\n  }\n}\n\nexport function addMetadataListener() {\n  document.addEventListener('app-metadata', OnAppMetadata)\n}\n\nfunction OnAppMetadata(e: CustomEvent<Metadata>) {\n  updateMetadata(e.detail)\n}\n\nexport type Metadata = { [key: string]: string }\n\nexport type MetadataEntry = { key: string, value: string }\n\nexport function updateMetadata(data: Metadata, entries?: MetadataEntry[][] ) {\n  syncMedatadata({ ...data, url: data.url || document.location.href }, entries)\n}\n\nconst head = document.head\n\nfunction syncMedatadata(data: Metadata, entries?: MetadataEntry[][]) {\n  const keys = Object.keys(data)\n\n  for (let i = 0; i < keys.length; i++) {\n    const key = keys[i]\n    const value = data[key]\n\n    switch (key) {\n      case 'title':\n        document.title = value\n        break;\n      default:\n        setMetaValue(0, key, value)\n        break\n    }\n\n    switch (key) {\n      case 'title':\n      case 'description':\n      case 'image':\n      case 'url':\n        setMetaValue(0, 'og:' + key, value)\n        setMetaValue(0, 'twitter:' + key, value)\n        break\n    }\n  }\n\n  if (entries) {\n    for (let i = 0; i < entries.length; i++) {\n      const set = entries[i]\n      for (let j = 0; j < set.length; j++) {\n        const entry = set[j]\n        setMetaValue(i, entry.key, entry.value)\n      }\n    }\n  }\n\n  cleanupUnused()\n}\n\n// keep track of added meta elements so that\n// they can be reused or removed as required\ntype metaMap = { [key: string]: HTMLMetaElement[] }\nconst metaElements: metaMap = {}\n\nconst propertyPrefixes = ['fb', 'og', 'product']\n\nfunction getAttrName(key: string) {\n  const parts = key.split(':')\n  return parts.length === 1 || propertyPrefixes.indexOf(parts[0]) === -1\n    ? 'name'\n    : 'property'\n}\n\nfunction setMetaValue(index: number, key: string, value: string) {\n  const attrName = getAttrName(key)\n\n  let element: HTMLMetaElement | undefined\n  let elements = metaElements[key]\n  if (elements) {\n    element = elements[index]\n  } else {\n    elements = []\n    metaElements[key] = elements\n  }\n\n  if (element) {\n    element.content = value\n  } else {\n    const selector = `meta[${attrName}=\"${key}\"]`\n\n    let element = index\n      ? <HTMLMetaElement>head.querySelectorAll(selector)[index]\n      : <HTMLMetaElement>head.querySelector(selector)\n\n    if (!element) {\n      // otherwise create a new element\n      element = document.createElement('meta')\n      element.setAttribute(attrName, key)\n      head.appendChild(element)\n    }\n\n    element.content = value\n    elements[index] = element\n  }\n\n  updated[key] = index + 1\n}\n\n// count of updated metadata used in each iteration\nlet updated : { [key: string]: number } = {}\n\n// cleanup previously existing metatags that are now unused\nfunction cleanupUnused() {\n  const keys = Object.keys(metaElements)\n  for (let i = 0; i < keys.length; i++) {\n    const key = keys[i]\n    const elements = metaElements[key]\n    const used = updated[key] || 0\n    if (elements.length > used) {\n      for (let n = used; n < elements.length; n++) {\n        head.removeChild(elements[n])\n      }\n      elements.splice(used)\n    }\n  }\n\n  // reset for next time\n  updated = {}\n}\n"],"names":["e","updateMetadata","detail","data","entries","keys","Object","i","length","key","value","document","title","setMetaValue","set","j","entry","metaElements","elements","used","updated","n","head","removeChild","splice","cleanupUnused","syncMedatadata","url","location","href","propertyPrefixes","index","attrName","parts","split","indexOf","getAttrName","element","content","selector","querySelectorAll","querySelector","createElement","setAttribute","appendChild","addEventListener","OnAppMetadata"],"mappings":"4CAUA,WAAuBA,GACrBC,EAAeD,EAAEE,mBAOYC,EAAgBC,IAM/C,SAAwBD,EAAgBC,GACtC,MAAMC,EAAOC,OAAOD,KAAKF,GAEzB,IAAK,IAAII,EAAI,EAAGA,EAAIF,EAAKG,OAAQD,IAAK,CACpC,MAAME,EAAMJ,EAAKE,GACXG,EAAQP,EAAKM,GAEnB,OAAQA,GACN,IAAK,QACHE,SAASC,MAAQF,EACjB,MACF,QACEG,EAAa,EAAGJ,EAAKC,GAIzB,OAAQD,GACN,IAAK,QACL,IAAK,cACL,IAAK,QACL,IAAK,MACHI,EAAa,EAAG,MAAQJ,EAAKC,GAC7BG,EAAa,EAAG,WAAaJ,EAAKC,IAKxC,GAAIN,EACF,IAAK,IAAIG,EAAI,EAAGA,EAAIH,EAAQI,OAAQD,IAAK,CACvC,MAAMO,EAAMV,EAAQG,GACpB,IAAK,IAAIQ,EAAI,EAAGA,EAAID,EAAIN,OAAQO,IAAK,CACnC,MAAMC,EAAQF,EAAIC,GAClBF,EAAaN,EAAGS,EAAMP,IAAKO,EAAMN,SA6DzC,WACE,MAAML,EAAOC,OAAOD,KAAKY,GACzB,IAAK,IAAIV,EAAI,EAAGA,EAAIF,EAAKG,OAAQD,IAAK,CACpC,MAAME,EAAMJ,EAAKE,GACXW,EAAWD,EAAaR,GACxBU,EAAOC,EAAQX,IAAQ,EAC7B,GAAIS,EAASV,OAASW,EAAM,CAC1B,IAAK,IAAIE,EAAIF,EAAME,EAAIH,EAASV,OAAQa,IACtCC,EAAKC,YAAYL,EAASG,IAE5BH,EAASM,OAAOL,IAKpBC,KAvEAK,GA1CAC,kBAAoBvB,GAAMwB,IAAKxB,EAAKwB,KAAOhB,SAASiB,SAASC,OAAQzB,GAGvE,MAAMkB,EAAOX,SAASW,KA6CtB,MAAML,KAEAa,GAAoB,KAAM,KAAM,WAStC,WAAsBC,EAAetB,EAAaC,GAChD,MAAMsB,EARR,SAAqBvB,GACnB,MAAMwB,EAAQxB,EAAIyB,MAAM,KACxB,OAAwB,IAAjBD,EAAMzB,SAAwD,IAAxCsB,EAAiBK,QAAQF,EAAM,IACxD,OACA,WAIaG,CAAY3B,GAE7B,IAAI4B,EACAnB,EAAWD,EAAaR,GAQ5B,GAPIS,EACFmB,EAAUnB,EAASa,IAEnBb,KACAD,EAAaR,GAAOS,GAGlBmB,EACFA,EAAQC,QAAU5B,MACb,CACL,MAAM6B,UAAmBP,MAAavB,MAEtC,IAAI4B,EAAUN,EACOT,EAAKkB,iBAAiBD,GAAUR,GAChCT,EAAKmB,cAAcF,GAEnCF,KAEHA,EAAU1B,SAAS+B,cAAc,SACzBC,aAAaX,EAAUvB,GAC/Ba,EAAKsB,YAAYP,IAGnBA,EAAQC,QAAU5B,EAClBQ,EAASa,GAASM,EAGpBjB,EAAQX,GAAOsB,EAAQ,EAIzB,IAAIX,sCA3GFT,SAASkC,iBAAiB,eAAgBC"}